<template>
  <el-dialog v-if="show" :before-close="cancel" :show-close="true" :title="form.id? '编辑资源':'添加资源'"
             :visible.sync="show"
             center destroy-on-close :close-on-click-modal="false"
             @close="cancel" width="50%">
    <el-form :model="form" ref="form" class="form" label-width="100px" :rules="rules">
      <el-card class="mb-4" shadow="hover">
        <template #header>
          <div class="card-header">
            <span class="font-bold">基本信息</span>
          </div>
        </template>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="资源名称" prop="name">
              <el-input v-model="form.name" placeholder="请输入资源名称" size="small"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="加载类型" prop="docker_type">
              <el-select v-model="form.docker_type" placeholder="请选择加载类型" class="w-full" size="small">
                <el-option v-for="op in docker_type_list" :label="op.label" :key="op.id" :value="op.id"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="24">
            <el-form-item label="镜像名称" prop="image">
              <el-input v-model="form.image" placeholder="请输入镜像名称" size="small"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
      </el-card>
      
      <el-card class="mb-4" shadow="hover">
        <template #header>
          <div class="card-header">
            <span class="font-bold">漏洞类型</span>
          </div>
        </template>
        <el-row :gutter="20">
          <el-col :span="24">
            <div class="cve-form-item">
              <label class="cve-label">CVE</label>
              <div class="cve-input-container">
                <el-input v-model="cveInput" placeholder="请输入CVE编号"></el-input>
                <el-button type="primary" @click="addCve">添加</el-button>
              </div>
              <div class="tag-container" v-if="form.cve && form.cve.length > 0">
                <el-tag
                  v-for="(tag, index) in form.cve"
                  :key="index"
                  closable
                  size="large"
                  @close="removeCve(index)"
                >
                  {{ tag }}
                </el-tag>
              </div>
            </div>
          </el-col>
        </el-row>
      </el-card>
      
      <el-card shadow="hover">
        <template #header>
          <div class="card-header">
            <span class="font-bold">漏洞描述</span>
          </div>
        </template>
        <el-form-item prop="description">
          <div class="markdown-container">
            <mavon-editor v-model="form.description" :toolbars="markdownToolbars" :boxShadow="false" placeholder="请输入漏洞描述信息"/>
          </div>
        </el-form-item>
      </el-card>
    </el-form>
    <span slot="footer" class="dialog-footer">
      <el-button @click="cancel">取 消</el-button>
      <el-button type="primary" @click="submit">确 定</el-button>
    </span>
  </el-dialog>
</template>

<script>
import {http} from "@/utils/http";
import {mavonEditor} from 'mavon-editor'
import 'mavon-editor/dist/css/index.css'
import {ElMessage} from 'element-plus'

export default {
  components: {
    mavonEditor
  },
  name: "addQuestion",
  props: {
    show: {
      type: Boolean
    },
    data: {
      type: Object
    }
  },
  data() {
    return {
      docker_type_list: [
        {
          label: "远程镜像",
          id: 1
        },
        {
          label: "本地镜像",
          id: 2
        }
      ],
      resource_list: [],
      hostOption: [],
      imageOption: [],
      capture: null,
      fileChange: false,
      options: [],
      cveInput: '',
      markdownToolbars: {
        bold: true,
        italic: true,
        header: true,
        underline: true,
        strikethrough: true,
        mark: true,
        superscript: true,
        subscript: true,
        quote: true,
        ol: true,
        ul: true,
        link: true,
        imagelink: true,
        code: true,
        table: true,
        fullscreen: true,
        readmodel: true,
        htmlcode: true,
        help: true,
        undo: true,
        redo: true,
        trash: true,
        save: true,
        navigation: true
      },
      attachment: [], // 临时附件对象
      form: {
        attachment: [],
        docker_type: null,
        image: null,
        name: null,
        description: null,
        cve: []
      },
      rules: {
        name: [
          {required: true, message: '请输入名称', trigger: 'blur'},
          {min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur'}
        ],
        docker_type: [
          {required: true, message: '请选择加载类型', trigger: 'change'},
        ],
        image: [
          {required: true, message: '请输入镜像名称', trigger: 'blur'},
        ],
        description: [
          {required: true, message: '请填写描述信息', trigger: 'blur'},
        ],
      },
    }
  },
  created() {
    this.getOptions()
    this.getResourceList()
    // 如果是编辑模式，初始化表单数据
    if (this.data && this.data.id) {
      this.form = JSON.parse(JSON.stringify(this.data))
      if (!this.form.cve) {
        this.form.cve = []
      }
    }
  },
  methods: {
    getOptions() {
      http.get('/api/admin/ctf/question/type').then(res => {
        this.options = res.data;
      })
    },
    getResourceList() {
      http.get('/api/admin/docker/resource', {"page_size": 99999, "status": 1}).then(res => {
        this.resource_list = res.data
      })
    },
    addCve() {
      if (!this.cveInput) {
        ElMessage.warning('请输入CVE编号')
        return
      }
      if (!this.form.cve) {
        this.form.cve = []
      }
      if (!this.form.cve.includes(this.cveInput)) {
        this.form.cve.push(this.cveInput)
        this.cveInput = ''
      } else {
        ElMessage.warning('该CVE编号已存在')
      }
    },
    removeCve(index) {
      this.form.cve.splice(index, 1)
    },
    cancel() {
      this.$emit('action', false)
    },
    submit() {
      this.$refs.form.validate(valid => {
        if (!valid) {
          return false
        }
        if (this.form.id) {
          http.put(`/api/admin/vulnerability/${this.form.id}`, this.form).then(res => {
            this.$emit('action', true)
            ElMessage({message: "更新成功", type: "success"})
          }).catch(err => {
            ElMessage.error(err.message || '更新失败')
          })
        } else {
          http.post(`/api/admin/vulnerability`, this.form).then(res => {
            this.$emit('action', true)
            ElMessage({message: "提交成功", type: "success"})
          }).catch(err => {
            ElMessage.error(err.message || '提交失败')
          })
        }
      })
    },
  },
}
</script>

<style lang="scss" scoped>
.form {
  margin: auto;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mb-4 {
  margin-bottom: 16px;
}

.w-full {
  width: 100%;
}

.markdown-container {
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  overflow: hidden;
}

.markdown-container :deep(.v-note-wrapper) {
  z-index: 1; /* 确保不会被其他元素覆盖 */
  min-height: 250px;
}

.flex {
  display: flex;
}

.items-center {
  align-items: center;
}

.flex-wrap {
  flex-wrap: wrap;
}

.mr-1 {
  margin-right: 4px;
}

.mr-2 {
  margin-right: 8px;
}

.mb-1 {
  margin-bottom: 4px;
}

.mt-2 {
  margin-top: 8px;
}

.font-bold {
  font-weight: bold;
}

/* 确保表单项在卡片内部有足够的间距 */
:deep(.el-form-item) {
  margin-bottom: 18px;
}

:deep(.el-form-item:last-child) {
  margin-bottom: 0;
}

/* 确保卡片内容有适当的内边距 */
:deep(.el-card__body) {
  padding: 16px;
}

/* 标签容器和标签样式 */
.tag-container {
  display: flex;
  flex-wrap: wrap;
  margin-top: 10px;
}

.cve-form-item {
  display: flex;
  margin-bottom: 18px;
}

.cve-label {
  width: 100px;
  text-align: left;
  line-height: 40px;
  color: #606266;
}

.cve-input-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  width: 300px;
}

.cve-input-container .el-input {
  width: 100%;
}

:deep(.el-tag) {
  margin: 0;
  cursor: default;
}

/* 确保输入框和下拉框有统一的高度 */
:deep(.el-input__inner),
:deep(.el-select__input) {
  height: 32px;
  line-height: 32px;
}

/* 统一表单元素的宽度 */
:deep(.el-input),
:deep(.el-select) {
  width: 100%;
}

/* 确保表单元素对齐 */
:deep(.el-form-item__label) {
  line-height: 32px;
  padding: 0 12px 0 0;
  height: 32px;
}

:deep(.el-form-item__content) {
  line-height: 32px;
}
</style>

