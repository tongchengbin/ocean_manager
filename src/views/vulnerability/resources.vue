<template>
  <div class="main">
    <resourceItem v-if="showAddQuestion" :data="chiData" :show="showAddQuestion" @action="handleAdd"/>

    <el-form class="search-form bg-bg_color w-[99/100] pl-8 pt-[12px]" :inline="true">
      <el-form-item class="el-form-item">
        <el-input v-model="listQuery.search" placeholder="请输入名称、app或CVE" class="w-[200px]"/>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="getList">查询</el-button>
        <el-button type="success" @click="handleCreate">添加</el-button>
        <el-button type="primary" @click="handleSyncRemoteVulnerabilityRepo">
          <el-tooltip content="同步远程仓库漏洞环境">同步</el-tooltip>
        </el-button>
      </el-form-item>
    </el-form>
    <div class="w-[99/100] mt-2 px-2 pb-2 bg-bg_color">
      <div class="flex justify-between w-full  page-title">
        <p class="font-bold truncate">漏洞资源列表</p>
      </div>
      <div>
        <el-table fit highlight-current-row stripe v-loading="loading" :data="listData">
          <el-table-column
            align="center"
            label="标题"
            prop="name"
            width="220"
            class-name="fnt-12"
          />
          <el-table-column
            align="center"
            label="组件"
            prop="app"
            width="220"
            class-name="fnt-12"
          />
          <el-table-column
            align="center"
            label="镜像"
            prop="image"
            class-name="fnt-12"
          >
            <template #default="scope">
              <span class="mr-1">{{ scope.row.image }}</span>
              <el-tag size="small" type="primary">{{ scope.row.docker_type === 1 ? '远程' : '本地' }}</el-tag>
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            label="状态"
            prop="status_name"
            width="180"
            class-name="fnt-12"
          >
            <template #default="scope">
              <el-tag
                :type="getStatusType(scope.row.status)"
                size="small"
                style="cursor: pointer"
                @click="scope.row.status === 2 && viewLogs(scope.row)"
              >
                {{ scope.row.status_name }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            label="CVE"
            prop="cve"
            width="220"
            class-name="fnt-12"
          >
            <template #default="scope">
              <el-tag
                v-for="i in scope.row.cve"
                :key="i"
                class="mr-1 mb-1"
                size="small"
              >
                {{ i }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            label="添加日期"
            prop="date_created"
            show-overflow-tooltip
            class-name="fnt-12"
          />
          <el-table-column
            align="center"
            label="操作"
            width="240"
          >
            <template #default="scope">
              <el-button v-if="scope.row.status !== 0" link type="primary" @click="buildHandle(scope.row)">编译
              </el-button>
              <el-button v-if="scope.row.status===1" link type="primary" @click="runHandle(scope.row)">启动</el-button>
              <el-button link type="primary" @click="editHandle(scope.row)">编辑</el-button>
              <el-button link type="danger" @click="deleteHandle(scope.row)">删除</el-button>
              <el-button
                v-if="scope.row.logs || scope.row.status === 2"
                link
                :type="scope.row.status === 2 ? 'danger' : 'info'"
                @click="viewLogs(scope.row)"
              >
                日志
              </el-button>
            </template>
          </el-table-column>
        </el-table>
        <div class="page-r">
          <el-pagination
            :current-page="listQuery.page"
            :page-size="listQuery.page_size"
            :page-sizes="[10,20,30,50]"
            :total="total"
            background
            layout="total, sizes, prev, pager, next, jumper"
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
          />
        </div>
      </div>
    </div>

    <el-dialog
      v-model="showLogs"
      title="编译日志"
      width="60%"
      class="log-dialog"
      destroy-on-close
    >
      <div class="log-content">
        <pre class="shell-style">{{ currentLogs }}</pre>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import {http} from "@/utils/http";
import resourceItem from "@/views/vulnerability/components/resourceItem.vue";
import {ElMessage, ElMessageBox} from "element-plus";

export default {
  name: "resources",
  components: {
    resourceItem,
  },
  data() {
    return {
      qType: [],
      listQuery: {
        page: 1,
        page_size: 10,
        subject: null,
        search: null
      },
      loading: false,
      chiData: {},
      showAddQuestion: false,
      total: 0,
      listData: [],
      rid: null,
      captureName: null,
      showLogs: false,
      currentLogs: ''
    }
  },
  created() {
    this.getList()
    this.getOptions()
  },
  methods: {
    getOptions() {
      http.get('/api/admin/ctf/question/type').then(res => {
        this.qType = res.data;
      }).catch(error => {
        ElMessage.error(error.message || '获取数据失败')
      })
    },
    getList() {
      this.loading = true
      http.get(`/api/admin/vulnerability`, this.listQuery).then(res => {
        this.listData = res.data;
        this.total = res.total
      }).catch(error => {
        ElMessage.error(error.message || '获取数据失败')
      }).finally(() => {
        this.loading = false
      })
    },
    handleSizeChange(e) {
      this.listQuery.page_size = e;
      this.getList()
    },
    handleCurrentChange(e) {
      this.listQuery.page = e;
      this.getList()
    },
    async handleSyncRemoteVulnerabilityRepo() {
      try {
        await http.post('/api/admin/vulnerability/sync_vulnerability', {})
        ElMessage({
          type: 'success',
          message: '任务提交成功',
          duration: 2000
        })
        this.getList()
      } catch (error) {
        ElMessage.error(error.message || '同步失败')
      }
    },
    handleUpload() {
      const input = document.createElement('input');
      input.type = 'file';
      input.addEventListener('change', this.handleFileUpload);
      input.click();
    },
    async handleFileUpload(event) {
      try {
        const file = event.target.files[0];
        const formData = new FormData();
        formData.append('file', file);
        await http.post('/api/admin/vulnerability/import', formData)
        ElMessage({
          type: 'success',
          message: '导入成功',
          duration: 2000
        })
        this.getList()
      } catch (error) {
        ElMessage.error(error.message || '导入失败')
      }
    },
    handleCreate() {
      this.$router.replace({name: "vulnerability.edit_resource"})
    },
    async buildHandle(row) {
      try {
        await http.post(`/api/admin/docker/resource/${row.id}/build`)
        ElMessage({
          type: 'success',
          message: '任务已提交',
          duration: 2000
        })
        this.getList()
      } catch (error) {
        ElMessage.error(error.message || '编译失败')
      }
    },
    editHandle(data) {
      this.$router.replace({
        name: "vulnerability.edit_resource",
        query: {id: data.id}
      })
    },
    async runHandle(row) {
      try {
        await http.post(`/api/admin/vulnerability/${row.id}/run`)
        ElMessage({
          type: 'success',
          message: '启动成功',
          duration: 2000
        })
        this.getList()
      } catch (error) {
        ElMessage.error(error.message || '启动失败')
      }
    },
    async deleteHandle(row) {
      try {
        await ElMessageBox.confirm('确认要删除该漏洞资源吗？', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        })

        await http.delete(`/api/admin/vulnerability/${row.id}`)
        ElMessage({
          type: 'success',
          message: '删除成功',
          duration: 2000
        })
        this.getList()
      } catch (error) {
        if (error !== 'cancel') {
          ElMessage.error(error.message || '删除失败')
        }
      }
    },
    handleAdd(e) {
      this.showAddQuestion = false;
      if (e) {
        this.getList()
      }
    },
    getStatusType(status) {
      const statusMap = {
        0: 'info', // 默认
        1: 'success', // 成功
        2: 'danger' // 失败
      }
      return statusMap[status] || 'info'
    },
    async switchActive(e, row) {
      try {
        await http.put(`/api/admin/ctf/question/${row.id}`, {active: e})
        ElMessage({
          type: 'success',
          message: '修改成功',
          duration: 2000
        })
      } catch (error) {
        ElMessage.error(error.message || '修改失败')
      }
    },
    async viewLogs(row) {
      this.currentLogs = row.logs || '暂无日志'
      this.showLogs = true
    }
  }
}
</script>

<style lang="scss">
.search-form {
  .el-form-item {
    margin-bottom: 10px;
  }
}

.log-dialog {
  :deep(.el-dialog) {
    border: none;
    box-shadow: none;
    background-color: #1e1e1e;
    margin-top: 8vh !important;

    .el-dialog__header {
      margin: 0;
      padding: 12px 16px;
      border: none;

      .el-dialog__title {
        color: #fff;
        font-size: 16px;
      }

      .el-dialog__headerbtn {
        top: 12px;

        .el-dialog__close {
          color: #fff;
          &:hover {
            color: #409eff;
          }
        }
      }
    }

    .el-dialog__body {
      padding: 0;
      border: none;
    }
  }

  .log-content {
    background-color: #1e1e1e;
    padding: 16px;
    max-height: 500px;
    overflow-y: auto;

    &::-webkit-scrollbar {
      width: 6px;
    }

    &::-webkit-scrollbar-thumb {
      background-color: #4a4a4a;
      border-radius: 3px;
    }

    &::-webkit-scrollbar-track {
      background-color: #1e1e1e;
    }

    pre.shell-style {
      color: #fff;
      font-family: Monaco, Consolas, Courier New, monospace;
      font-size: 14px;
      line-height: 1.5;
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
  }
}

.el-pagination {
  margin-top: 20px;
  justify-content: flex-end;
}

.fnt-12 {
  font-size: 12px;
}
</style>
