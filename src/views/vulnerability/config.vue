<template>
  <div class="main">
    <div class="w-[99/100] mt-2 px-2 pb-2 bg-bg_color">
      <div class="flex justify-between w-full h-[60px] p-4">
        <p class="font-bold truncate">漏洞配置</p>
      </div>
      <div class="px-4">
        <el-form 
          ref="form"
          :model="form"
          :rules="rules"
          label-width="140px"
          class="max-w-[800px]"
        >
          <el-form-item 
            label="环境时长" 
            prop="vulnerability_timeout"
          >
            <el-input-number 
              v-model="form.vulnerability_timeout"
              :min="1"
              :max="3600"
              placeholder="请输入环境时长"
            >
              <template #suffix>秒</template>
            </el-input-number>
          </el-form-item>
          <el-form-item 
            label="漏洞仓库" 
            prop="remote_vulnerability_repository"
          >
            <el-input 
              v-model="form.remote_vulnerability_repository"
              placeholder="请输入漏洞仓库地址"
              class="w-[400px]"
            />
          </el-form-item>
          <el-form-item>
            <el-button 
              type="primary" 
              @click="handleSubmit"
            >
              保存配置
            </el-button>
          </el-form-item>
        </el-form>
      </div>
    </div>
  </div>
</template>

<script>
import { http } from "@/utils/http";
import { ElMessage } from "element-plus";

export default {
  name: "ctf",
  data() {
    return {
      form: {
        remote_vulnerability_repository: '',
        vulnerability_timeout: 180
      },
      rules: {
        vulnerability_timeout: [
          { required: true, message: '请输入环境时长', trigger: 'blur' },
          { type: 'number', min: 1, max: 3600, message: '时长必须在1-3600秒之间', trigger: 'blur' }
        ],
        remote_vulnerability_repository: [
          { required: true, message: '请输入漏洞仓库地址', trigger: 'blur' }
        ]
      }
    }
  },
  created() {
    this.getConfig()
  },
  methods: {
    async getConfig() {
      try {
        const res = await http.get('/api/admin/config')
        this.form = {
          remote_vulnerability_repository: res.data.remote_vulnerability_repository,
          vulnerability_timeout: res.data.vulnerability_timeout || 180
        }
      } catch (error) {
        ElMessage.error(error.message || '获取配置失败')
      }
    },
    async handleSubmit() {
      try {
        await this.$refs.form.validate()
        
        await http.post('/api/admin/config', this.form)
        ElMessage({
          type: 'success',
          message: '保存成功',
          duration: 2000
        })
        this.getConfig()
      } catch (error) {
        if (error !== 'cancel') {
          ElMessage.error(error.message || '保存失败')
        }
      }
    }
  }
}
</script>

<style lang="scss">
.el-form-item {
  margin-bottom: 22px;
}
</style>
